---
# file: roles/openldap/tasks/main.yml
- name: packages install
  yum: name={{item}} state=present
  with_items:
    - openldap-servers
    - openldap-clients

- name: ldap db config.
  template: src=DB_CONFIG.j2 dest=/var/lib/ldap/DB_CONFIG owner=ldap group=ldap

- name: ldap settings
  template: src=slapd.conf.j2 dest=/etc/openldap/slapd.conf

- name: ldap db check
  command: ls -l /etc/openldap/slapd.d
  register: ldap_db_check
  failed_when: ldap_db_check.rc not in [0,1,2]
  changed_when: ldap_db_check.stdout.find('cn=config') != -1

- name: delete ldap default db
  shell: rm -rf /etc/openldap/slapd.d/*
  when: ldap_db_check.stdout.find('cn=config') != -1
